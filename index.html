<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hyundai Santa Fe – Colour Compare</title>
  <style>
    :root{
      --bg: #f3f4f6;
      --panel: rgba(255,255,255,0.86);
      --text: #111827;
      --muted: #6b7280;
      --border: rgba(17,24,39,0.12);
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
      --radius: 16px;
      --accentA: rgba(59,130,246,0.7);
      --accentB: rgba(16,185,129,0.7);
    }
    [data-theme="dark"]{
      --bg:#0b1020;
      --panel: rgba(17,24,39,0.74);
      --text:#f9fafb;
      --muted:#cbd5e1;
      --border: rgba(255,255,255,0.14);
      --shadow: 0 12px 34px rgba(0,0,0,0.35);
    }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
    }
    header{
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(255,255,255,0.65), rgba(255,255,255,0.25));
      border-bottom: 1px solid var(--border);
    }
    [data-theme="dark"] header{
      background: linear-gradient(to bottom, rgba(3,7,18,0.70), rgba(3,7,18,0.25));
    }
    .wrap{ max-width: 1500px; margin: 0 auto; padding: 16px; }
    .titleRow{
      display:flex; gap: 14px; align-items: center; justify-content: space-between; flex-wrap: wrap;
    }
    h1{ font-size: 18px; margin: 0; letter-spacing: 0.2px; }
    .controls{ display:flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .control{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 999px;
      box-shadow: var(--shadow);
    }
    label{ font-size: 12px; color: var(--muted); }
    select{
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 12px;
      outline: none;
    }
    button{
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    button:hover{ filter: brightness(0.98); }
    button.primary{
      background: var(--panel);
      box-shadow: var(--shadow);
    }
    button.playing{
      outline: 2px solid rgba(34,197,94,0.55);
      outline-offset: 2px;
    }
    .hint{
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      font-size: 12px;
      color: var(--muted);
    }
    .pill b{ color: var(--text); }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    main .wrap{ padding-top: 18px; padding-bottom: 28px; }

    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 14px;
      align-items: stretch;
    }
    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction: column;
      min-height: 240px;
      cursor: zoom-in;
      user-select: none;
      transition: transform 180ms ease, outline-color 180ms ease, box-shadow 180ms ease;
      outline: 2px solid transparent;
      outline-offset: 2px;
      position: relative;
    }
    .card:hover{ transform: translateY(-1px); }
    .card.pickA{ outline-color: var(--accentA); box-shadow: 0 12px 36px rgba(59,130,246,0.12); }

    .badge{
      position: absolute;
      top: 10px;
      left: 10px;
      color: #fff;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      display:none;
      pointer-events: none;
      z-index: 2;
    }

    .imgWrap{
      position: relative;
      aspect-ratio: 16 / 9;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.55), rgba(255,255,255,0) 60%),
        linear-gradient(135deg, rgba(255,255,255,0.10), rgba(0,0,0,0.08));
      overflow: hidden;
    }
    [data-theme="dark"] .imgWrap{
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.18), rgba(255,255,255,0) 60%),
        linear-gradient(135deg, rgba(255,255,255,0.06), rgba(0,0,0,0.30));
    }
    .imgLayer{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit: contain;
      transform: translateZ(0);
      transition: opacity 280ms linear;
      opacity: 0;
    }
    .imgLayer.visible{ opacity: 1; }

    .meta{ padding: 12px 12px 14px; display:flex; flex-direction: column; gap: 6px; }
    .name{ font-weight: 650; font-size: 14px; line-height: 1.2; }
    .code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Overlay base */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .overlay.open{ display:flex; }

    .overlayCard{
      width: min(1300px, 98vw);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.45);
      overflow:hidden;
      position: relative;
    }
    .overlayImgWrap{
      position: relative;
      aspect-ratio: 16 / 9;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.55), rgba(255,255,255,0) 60%),
        linear-gradient(135deg, rgba(255,255,255,0.10), rgba(0,0,0,0.08));
      overflow:hidden;
    }
    [data-theme="dark"] .overlayImgWrap{
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,0.18), rgba(255,255,255,0) 60%),
        linear-gradient(135deg, rgba(255,255,255,0.06), rgba(0,0,0,0.30));
    }
    .overlayMeta{
      padding: 14px 16px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
    }
    .overlayTitle{ font-weight: 750; font-size: 14px; }
    .overlayHint{ color: var(--muted); font-size: 12px; }

    .navBtn, .closeBtn{
      position: absolute;
      border-radius: 999px;
      padding: 10px 12px;
      background: rgba(0,0,0,0.45);
      color: white;
      border: 1px solid rgba(255,255,255,0.25);
      cursor: pointer;
      user-select:none;
      z-index: 3;
    }
    .navBtn:hover, .closeBtn:hover{ background: rgba(0,0,0,0.55); }
    .navBtn{ top: 50%; transform: translateY(-50%); }
    .navLeft{ left: 10px; }
    .navRight{ right: 10px; }
    .closeBtn{ top: 10px; right: 10px; padding: 8px 10px; }

    /* Compare overlay */
    .compareCard{
      width: min(1500px, 98vw);
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 22px;
      box-shadow: 0 25px 80px rgba(0,0,0,0.45);
      overflow:hidden;
      position: relative;
    }
    .compareTopbar{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 12px 12px;
      border-bottom: 1px solid var(--border);
    }
    .compareTopbar .left{
      display:flex; gap: 10px; align-items: center; flex-wrap: wrap;
      font-size: 12px; color: var(--muted);
    }
    .compareTopbar .left b{ color: var(--text); }
    .compareTopbar .right{ display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }

    .compareGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
    }
    @media (max-width: 900px){
      .compareGrid{ grid-template-columns: 1fr; }
    }
    .pane{
      position: relative;
      border-right: 1px solid var(--border);
    }
    @media (max-width: 900px){
      .pane{ border-right: none; border-bottom: 1px solid var(--border); }
    }
    .pane:last-child{ border-right: none; border-bottom: none; }

    .paneHeader{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
    }
    .paneHeader .tag{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-weight: 750;
      font-size: 12px;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: var(--accentA);
      display:inline-block;
    }
    .dot.b{ background: var(--accentB); }

    .paneHeader .name{
      font-weight: 700;
      font-size: 12px;
      margin: 0;
      color: var(--text);
    }
    .paneHeader .sub{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 70ch;
    }

    .paneImgWrap{
      position: relative;
      aspect-ratio: 16/9;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      /* Enables drag gestures (pointer events) cleanly on mobile */
      touch-action: none;
      cursor: ew-resize;
    }

    .paneNav{
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      display:flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      z-index: 3;
    }
    .paneNav.left{ left: 6px; }
    .paneNav.right{ right: 6px; }
    .paneNav button{
      background: rgba(0,0,0,0.45);
      color: white;
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: none;
    }
    .paneNav button:hover{ background: rgba(0,0,0,0.55); }
  </style>
</head>

<body data-theme="light">
  <header>
    <div class="wrap">
      <div class="titleRow">
        <h1>Hyundai Santa Fe — colour compare (UK labels)</h1>

        <div class="controls">
          <div class="control">
            <label for="frame">Rotation frame</label>
            <select id="frame"></select>
          </div>

          <div class="control">
            <label for="size">Image width</label>
            <select id="size">
              <option value="1200">1200</option>
              <option value="1600" selected>1600</option>
              <option value="2000">2000</option>
            </select>
          </div>

          <button id="playBtn" class="primary" type="button">▶ Rotate</button>

          <div class="control">
            <label for="speed">Speed</label>
            <select id="speed">
              <option value="500">0.5s</option>
              <option value="1000" selected>1s</option>
              <option value="2000">2s</option>
              <option value="5000">5s</option>
            </select>
          </div>

          <button id="compareBtn" class="primary" type="button">2-up compare</button>
          <button id="toggleTheme" type="button">Toggle background</button>
        </div>
      </div>

      <div class="hint">
        <span class="pill">Smooth rotate: crossfade + preload • wraps <b>036 → 001</b> continuously</span>
        <span class="pill">Zoom: click a tile • <span class="kbd">←</span>/<span class="kbd">→</span> • <span class="kbd">Esc</span></span>
        <span class="pill">2-up: click <b>2-up compare</b>, then pick colour <b>A</b> and <b>B</b></span>
        <span class="pill" id="pickPill" style="display:none;"><b>Picking…</b> <span id="pickText">Select A</span> • <span class="kbd">Esc</span> to cancel</span>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div id="grid" class="grid"></div>
    </div>
  </main>

  <!-- Single zoom overlay -->
  <div id="zoomOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Zoomed colour">
    <div class="overlayCard">
      <button class="closeBtn" id="zoomClose" title="Close (Esc)">✕</button>
      <button class="navBtn navLeft" id="zoomPrev" title="Previous (←)">←</button>
      <button class="navBtn navRight" id="zoomNext" title="Next (→)">→</button>

      <div class="overlayImgWrap" id="zoomImgWrap">
        <img class="imgLayer" id="zoomLayerA" alt="" />
        <img class="imgLayer" id="zoomLayerB" alt="" />
      </div>

      <div class="overlayMeta">
        <div class="overlayTitle" id="zoomTitle"></div>
        <div class="overlayHint" id="zoomHint"></div>
      </div>
    </div>
  </div>

  <!-- 2-up compare overlay -->
  <div id="compareOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Two-up comparison">
    <div class="compareCard" id="compareCard">
      <button class="closeBtn" id="compareClose" title="Close (Esc)">✕</button>

      <div class="compareTopbar">
        <div class="left">
          <span><b>2-up compare</b></span>
          <span id="compareMeta">Frame 002 • 1600px</span>

          <div class="control" style="padding:6px 8px; box-shadow:none;">
            <label for="compareFrame" style="margin-right:6px;">Rotation</label>
            <select id="compareFrame"></select>
          </div>

          <span class="pill" style="padding:6px 10px; box-shadow:none; border-color: var(--border);">
            Drag on images to rotate
          </span>

          <span class="kbd">A: Q/W • B: O/P</span>
        </div>
        <div class="right">
          <button id="swapBtn" type="button">Swap</button>
          <button id="repickBtn" type="button">Pick different colours</button>
        </div>
      </div>

      <div class="compareGrid" id="compareGrid">
        <div class="pane">
          <div class="paneHeader">
            <div class="tag"><span class="dot"></span> A</div>
            <div style="text-align:right;">
              <div class="name" id="nameA">—</div>
              <div class="sub" id="subA">Controls: Q/W</div>
            </div>
          </div>
          <div class="paneImgWrap overlayImgWrap" id="paneAWrap">
            <img class="imgLayer" id="paneALayerA" alt="Compare A" />
            <img class="imgLayer" id="paneALayerB" alt="Compare A" />
          </div>
          <div class="paneNav left">
            <button id="prevA" title="A previous (Q)">Q</button>
          </div>
          <div class="paneNav right">
            <button id="nextA" title="A next (W)">W</button>
          </div>
        </div>

        <div class="pane">
          <div class="paneHeader">
            <div class="tag"><span class="dot b"></span> B</div>
            <div style="text-align:right;">
              <div class="name" id="nameB">—</div>
              <div class="sub" id="subB">Controls: O/P</div>
            </div>
          </div>
          <div class="paneImgWrap overlayImgWrap" id="paneBWrap">
            <img class="imgLayer" id="paneBLayerA" alt="Compare B" />
            <img class="imgLayer" id="paneBLayerB" alt="Compare B" />
          </div>
          <div class="paneNav left">
            <button id="prevB" title="B previous (O)">O</button>
          </div>
          <div class="paneNav right">
            <button id="nextB" title="B next (P)">P</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const modelId = "52910NI000";
  const TOTAL_FRAMES = 36;

  // IMPORTANT: mixed-width padding:
  // 1–9  => 001..009
  // 10+  => 0010..0036
  const frames = Array.from({ length: TOTAL_FRAMES }, (_, i) => {
    const n = i + 1;
    return n < 10 ? String(n).padStart(3, "0") : String(n).padStart(4, "0");
  });

  const colours = [
    { displayName: "Cyber Sage Pearl",      paintCode: "RS2", assetName: "Cyber Sage Pearl" },
    { displayName: "Creamy White Matte",    paintCode: "WWM", assetName: "Creamy White Matte" },
    { displayName: "Abyss Black Pearl",     paintCode: "A2B", assetName: "Abyss Black Pearl" },
    { displayName: "Ocado Green Pearl",     paintCode: "RN2", assetName: "Ocado Green Pearl" },
    { displayName: "Terracotta Orange",     paintCode: "ZGE", assetName: "Terracotta Orange Solid" },
    { displayName: "Earthy Brass",          paintCode: "YBM", assetName: "Earthy Brass Metallic" },
    { displayName: "Pebble Blue Pearl",     paintCode: "PB2", assetName: "Pebble Blue Pearl" },
    { displayName: "Ecotronic Grey Pearl",  paintCode: "M2F", assetName: "Magnetic Gray" },
    { displayName: "Typhoon Silver",        paintCode: "T2X", assetName: "Typhoon Silver Metallic" },
  ];

  const els = {
    grid: document.getElementById("grid"),
    frame: document.getElementById("frame"),
    size: document.getElementById("size"),
    toggleTheme: document.getElementById("toggleTheme"),

    playBtn: document.getElementById("playBtn"),
    speed: document.getElementById("speed"),

    pickPill: document.getElementById("pickPill"),
    pickText: document.getElementById("pickText"),
    compareBtn: document.getElementById("compareBtn"),

    zoomOverlay: document.getElementById("zoomOverlay"),
    zoomTitle: document.getElementById("zoomTitle"),
    zoomHint: document.getElementById("zoomHint"),
    zoomPrev: document.getElementById("zoomPrev"),
    zoomNext: document.getElementById("zoomNext"),
    zoomClose: document.getElementById("zoomClose"),
    zoomLayerA: document.getElementById("zoomLayerA"),
    zoomLayerB: document.getElementById("zoomLayerB"),

    compareOverlay: document.getElementById("compareOverlay"),
    compareCard: document.getElementById("compareCard"),
    compareGrid: document.getElementById("compareGrid"),
    compareClose: document.getElementById("compareClose"),
    compareMeta: document.getElementById("compareMeta"),
    compareFrame: document.getElementById("compareFrame"),
    swapBtn: document.getElementById("swapBtn"),
    repickBtn: document.getElementById("repickBtn"),
    nameA: document.getElementById("nameA"),
    nameB: document.getElementById("nameB"),
    prevA: document.getElementById("prevA"),
    nextA: document.getElementById("nextA"),
    prevB: document.getElementById("prevB"),
    nextB: document.getElementById("nextB"),

    paneALayerA: document.getElementById("paneALayerA"),
    paneALayerB: document.getElementById("paneALayerB"),
    paneBLayerA: document.getElementById("paneBLayerA"),
    paneBLayerB: document.getElementById("paneBLayerB"),
    paneAWrap: document.getElementById("paneAWrap"),
    paneBWrap: document.getElementById("paneBWrap"),
  };

  // state
  let zoomIndex = -1;

  let pickMode = false;
  let pickStep = 0;
  let compareA = null;
  let compareB = null;

  // rotation animation state
  let playing = false;
  let rotationTimer = null;

  // Crossfade state for overlays
  const zoomFade = { frontIsA: true };
  const compareFadeA = { frontIsA: true };
  const compareFadeB = { frontIsA: true };

  function encodePlus(str){
    return encodeURIComponent(str).replace(/%20/g, "+");
  }

  function buildUrl(col, frame, wid){
    const colourPart = `${col.paintCode}-${encodePlus(col.assetName)}`;
    const hei = Math.round(Number(wid) * 0.5625);
    return `https://dmassets.hyundai.com/is/image/hyundaiautoever/HME_MX5_360_EXT_${colourPart}_${modelId}_${frame}?wid=${wid}&hei=${hei}&fmt=png-alpha&fit=wrap,1`;
  }

  function preload(src){
    return new Promise((resolve, reject) => {
      const im = new Image();
      im.onload = () => resolve(src);
      im.onerror = reject;
      im.src = src;
    });
  }

  async function crossfadeTo(layerA, layerB, stateObj, nextSrc){
    try { await preload(nextSrc); } catch {}
    const front = stateObj.frontIsA ? layerA : layerB;
    const back  = stateObj.frontIsA ? layerB : layerA;

    back.src = nextSrc;
    back.classList.add("visible");
    front.classList.remove("visible");
    stateObj.frontIsA = !stateObj.frontIsA;
  }

  function makeCard(col, idx){
    const card = document.createElement("div");
    card.className = "card";
    card.tabIndex = 0;
    card.setAttribute("role", "button");

    const badge = document.createElement("div");
    badge.className = "badge";
    card.appendChild(badge);

    const imgWrap = document.createElement("div");
    imgWrap.className = "imgWrap";

    const layerA = document.createElement("img");
    const layerB = document.createElement("img");
    layerA.className = "imgLayer visible";
    layerB.className = "imgLayer";

    layerA.alt = `Hyundai Santa Fe – ${col.displayName}`;
    layerB.alt = `Hyundai Santa Fe – ${col.displayName}`;

    imgWrap.appendChild(layerA);
    imgWrap.appendChild(layerB);

    const meta = document.createElement("div");
    meta.className = "meta";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = col.displayName;

    const code = document.createElement("div");
    code.className = "code";
    code.textContent = `${col.paintCode}-${col.assetName}`;

    meta.appendChild(name);
    meta.appendChild(code);

    card.appendChild(imgWrap);
    card.appendChild(meta);

    col._card = card;
    col._badge = badge;
    col._layerA = layerA;
    col._layerB = layerB;
    col._fade = { frontIsA: true };

    const activate = () => {
      if (pickMode) handlePick(idx);
      else openZoom(idx);
    };

    card.addEventListener("click", activate);
    card.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") { e.preventDefault(); activate(); }
    });

    return card;
  }

  function populateDropdown(selectEl){
    selectEl.innerHTML = "";
    frames.forEach(f => {
      const opt = document.createElement("option");
      opt.value = f;
      opt.textContent = f;
      selectEl.appendChild(opt);
    });
  }

  function render(){
    populateDropdown(els.frame);
    populateDropdown(els.compareFrame);

    els.frame.value = "002";
    els.compareFrame.value = els.frame.value;

    els.grid.innerHTML = "";
    const frag = document.createDocumentFragment();
    colours.forEach((c, idx) => frag.appendChild(makeCard(c, idx)));
    els.grid.appendChild(frag);

    // initial load
    const frame = els.frame.value;
    const wid = els.size.value;
    colours.forEach(c => {
      const src = buildUrl(c, frame, wid);
      c._layerA.src = src;
      c._layerB.src = src;
      c._layerA.classList.add("visible");
      c._layerB.classList.remove("visible");
      c._fade.frontIsA = true;
    });

    updateOverlayHints();
    refreshPickUI();
    updatePlayButton();
    setupCompareDragRotate();
  }

  function updateOverlayHints(){
    const frame = els.frame.value;
    const wid = els.size.value;
    els.compareMeta.textContent = `Frame ${frame} • ${wid}px`;
    if (els.zoomOverlay.classList.contains("open") && zoomIndex >= 0){
      els.zoomHint.textContent = `Frame ${frame} • ${wid}px • ←/→ • Esc`;
    }
  }

  async function updateAllImagesSmooth(){
    const frame = els.frame.value;
    const wid = els.size.value;

    els.compareFrame.value = frame;

    // Grid
    for (const c of colours){
      crossfadeTo(c._layerA, c._layerB, c._fade, buildUrl(c, frame, wid));
    }

    // Zoom
    if (els.zoomOverlay.classList.contains("open") && zoomIndex >= 0){
      const c = colours[zoomIndex];
      els.zoomTitle.textContent = c.displayName;
      crossfadeTo(els.zoomLayerA, els.zoomLayerB, zoomFade, buildUrl(c, frame, wid));
      els.zoomHint.textContent = `Frame ${frame} • ${wid}px • ←/→ • Esc`;
    }

    // Compare
    if (els.compareOverlay.classList.contains("open") && compareA !== null && compareB !== null){
      const a = colours[compareA];
      const b = colours[compareB];
      els.nameA.textContent = a.displayName;
      els.nameB.textContent = b.displayName;
      crossfadeTo(els.paneALayerA, els.paneALayerB, compareFadeA, buildUrl(a, frame, wid));
      crossfadeTo(els.paneBLayerA, els.paneBLayerB, compareFadeB, buildUrl(b, frame, wid));
    }

    updateOverlayHints();
  }

  // ---- Rotation animation ----
  function updatePlayButton(){
    els.playBtn.textContent = playing ? "⏸ Stop" : "▶ Rotate";
    els.playBtn.classList.toggle("playing", playing);
  }

  function stopRotation(){
    playing = false;
    if (rotationTimer) clearInterval(rotationTimer);
    rotationTimer = null;
    updatePlayButton();
  }

  function startRotation(){
    playing = true;
    updatePlayButton();

    const intervalMs = Number(els.speed.value);
    if (rotationTimer) clearInterval(rotationTimer);

    rotationTimer = setInterval(() => {
      const idx = frames.indexOf(els.frame.value);
      const next = frames[(idx + 1) % frames.length]; // wraps last -> first
      els.frame.value = next;
      updateAllImagesSmooth();
    }, intervalMs);
  }

  function toggleRotation(){
    if (playing) stopRotation();
    else startRotation();
  }

  els.playBtn.addEventListener("click", toggleRotation);
  els.speed.addEventListener("change", () => { if (playing) startRotation(); });
  document.addEventListener("visibilitychange", () => { if (document.hidden && playing) stopRotation(); });

  // ---- Zoom overlay ----
  function openZoom(index){
    zoomIndex = index;
    const c = colours[zoomIndex];
    const frame = els.frame.value;
    const wid = els.size.value;

    els.zoomTitle.textContent = c.displayName;
    els.zoomHint.textContent = `Frame ${frame} • ${wid}px • ←/→ • Esc`;

    const src = buildUrl(c, frame, wid);
    els.zoomLayerA.src = src;
    els.zoomLayerB.src = src;
    els.zoomLayerA.classList.add("visible");
    els.zoomLayerB.classList.remove("visible");
    zoomFade.frontIsA = true;

    els.zoomOverlay.classList.add("open");
  }

  function closeZoom(){
    els.zoomOverlay.classList.remove("open");
    zoomIndex = -1;
  }

  function navZoom(dir){
    if (zoomIndex < 0) return;
    zoomIndex = (zoomIndex + dir + colours.length) % colours.length;
    openZoom(zoomIndex);
  }

  els.zoomPrev.addEventListener("click", (e) => { e.stopPropagation(); navZoom(-1); });
  els.zoomNext.addEventListener("click", (e) => { e.stopPropagation(); navZoom(+1); });
  els.zoomClose.addEventListener("click", (e) => { e.stopPropagation(); closeZoom(); });
  els.zoomOverlay.addEventListener("click", (e) => { if (e.target === els.zoomOverlay) closeZoom(); });

  // ---- 2-up compare pick ----
  function startPick(){
    pickMode = true;
    pickStep = 0;
    compareA = null;
    compareB = null;
    refreshPickUI();
  }

  function cancelPick(){
    pickMode = false;
    pickStep = 0;
    compareA = null;
    compareB = null;
    refreshPickUI();
  }

  function handlePick(idx){
    if (pickStep === 0){
      compareA = idx;
      pickStep = 1;
    } else {
      compareB = idx;
      if (compareB === compareA) { compareB = null; return; }
      pickMode = false;
      pickStep = 0;
      refreshPickUI();
      openCompareOverlay(compareA, compareB, false);
    }
    refreshPickUI();
  }

  function refreshPickUI(){
    els.pickPill.style.display = pickMode ? "inline-flex" : "none";
    els.pickText.textContent = pickMode ? (pickStep === 0 ? "Select A" : "Select B") : "";

    colours.forEach((c, idx) => {
      c._card.classList.remove("pickA");
      c._badge.style.display = "none";
      if (!pickMode) return;

      if (pickStep === 1 && compareA === idx){
        c._card.classList.add("pickA");
        c._badge.style.display = "inline-block";
        c._badge.textContent = "A";
        c._badge.style.background = "var(--accentA)";
      }
    });
  }

  function openCompareOverlay(aIdx, bIdx, keepOpen){
    const frame = els.frame.value;
    const wid = els.size.value;

    const a = colours[aIdx];
    const b = colours[bIdx];

    els.compareMeta.textContent = `Frame ${frame} • ${wid}px`;
    els.compareFrame.value = frame;

    els.nameA.textContent = a.displayName;
    els.nameB.textContent = b.displayName;

    const srcA = buildUrl(a, frame, wid);
    const srcB = buildUrl(b, frame, wid);

    els.paneALayerA.src = srcA; els.paneALayerB.src = srcA;
    els.paneALayerA.classList.add("visible"); els.paneALayerB.classList.remove("visible");
    compareFadeA.frontIsA = true;

    els.paneBLayerA.src = srcB; els.paneBLayerB.src = srcB;
    els.paneBLayerA.classList.add("visible"); els.paneBLayerB.classList.remove("visible");
    compareFadeB.frontIsA = true;

    if (!keepOpen) els.compareOverlay.classList.add("open");
  }

  function closeCompareOverlay(){ els.compareOverlay.classList.remove("open"); }

  function swapCompare(){
    const t = compareA; compareA = compareB; compareB = t;
    openCompareOverlay(compareA, compareB, true);
  }

  function stepA(dir){
    compareA = (compareA + dir + colours.length) % colours.length;
    if (compareA === compareB) compareA = (compareA + dir + colours.length) % colours.length;
    openCompareOverlay(compareA, compareB, true);
  }
  function stepB(dir){
    compareB = (compareB + dir + colours.length) % colours.length;
    if (compareB === compareA) compareB = (compareB + dir + colours.length) % colours.length;
    openCompareOverlay(compareA, compareB, true);
  }

  els.compareBtn.addEventListener("click", () => { if (pickMode) cancelPick(); else startPick(); });
  els.swapBtn.addEventListener("click", () => swapCompare());
  els.repickBtn.addEventListener("click", () => { closeCompareOverlay(); startPick(); });
  els.compareClose.addEventListener("click", () => closeCompareOverlay());

  els.prevA.addEventListener("click", (e) => { e.stopPropagation(); stepA(-1); });
  els.nextA.addEventListener("click", (e) => { e.stopPropagation(); stepA(+1); });
  els.prevB.addEventListener("click", (e) => { e.stopPropagation(); stepB(-1); });
  els.nextB.addEventListener("click", (e) => { e.stopPropagation(); stepB(+1); });

  els.compareOverlay.addEventListener("click", (e) => { if (e.target === els.compareOverlay) closeCompareOverlay(); });

  // Compare rotation dropdown controls global frame
  els.compareFrame.addEventListener("change", () => {
    if (playing) stopRotation();
    els.frame.value = els.compareFrame.value;
    updateAllImagesSmooth();
  });

  // ---- Main controls ----
  els.frame.addEventListener("change", () => {
    els.compareFrame.value = els.frame.value;
    updateAllImagesSmooth();
  });

  els.size.addEventListener("change", () => {
    const frame = els.frame.value;
    const wid = els.size.value;
    colours.forEach(c => {
      const src = buildUrl(c, frame, wid);
      c._layerA.src = src; c._layerB.src = src;
      c._layerA.classList.add("visible"); c._layerB.classList.remove("visible");
      c._fade.frontIsA = true;
    });
    if (els.zoomOverlay.classList.contains("open") && zoomIndex >= 0) openZoom(zoomIndex);
    if (els.compareOverlay.classList.contains("open") && compareA !== null && compareB !== null) openCompareOverlay(compareA, compareB, true);
    updateOverlayHints();
  });

  els.toggleTheme.addEventListener("click", () => {
    document.body.dataset.theme = document.body.dataset.theme === "dark" ? "light" : "dark";
  });

  // ---- Keyboard shortcuts ----
  document.addEventListener("keydown", (e) => {
    if (pickMode && e.key === "Escape"){ cancelPick(); return; }

    if (els.zoomOverlay.classList.contains("open")){
      if (e.key === "Escape") closeZoom();
      if (e.key === "ArrowLeft") navZoom(-1);
      if (e.key === "ArrowRight") navZoom(+1);
      return;
    }

    if (els.compareOverlay.classList.contains("open")){
      if (e.key === "Escape") closeCompareOverlay();
      if (e.key.toLowerCase() === "q") stepA(-1);
      if (e.key.toLowerCase() === "w") stepA(+1);
      if (e.key.toLowerCase() === "o") stepB(-1);
      if (e.key.toLowerCase() === "p") stepB(+1);
      if (e.key.toLowerCase() === "s") swapCompare();
      return;
    }
  });

  // ---- Drag/gesture rotation in compare popup ----
  function setupCompareDragRotate(){
    const drag = {
      active: false,
      pointerId: null,
      startX: 0,
      startIdx: 0,
      pxPerFrame: 18  // smaller = more sensitive rotation
    };

    function currentFrameIndex(){
      return Math.max(0, frames.indexOf(els.frame.value));
    }
    function setFrameByIndex(idx){
      const wrapped = ((idx % frames.length) + frames.length) % frames.length;
      els.frame.value = frames[wrapped];
      els.compareFrame.value = els.frame.value;
      updateAllImagesSmooth();
    }

    function onDown(e){
      if (!els.compareOverlay.classList.contains("open")) return;

      // Only start drag if user pressed on one of the image panes (not the top bar controls)
      const inPane = e.target && (e.target.closest("#paneAWrap") || e.target.closest("#paneBWrap"));
      if (!inPane) return;

      // Stop auto-rotate so gesture "sticks"
      if (playing) stopRotation();

      drag.active = true;
      drag.pointerId = e.pointerId;
      drag.startX = e.clientX;
      drag.startIdx = currentFrameIndex();

      // capture pointer so moves still work if you leave the element
      try { inPane.setPointerCapture(e.pointerId); } catch {}
      e.preventDefault();
    }

    function onMove(e){
      if (!drag.active || e.pointerId !== drag.pointerId) return;
      const dx = e.clientX - drag.startX;

      // Convert horizontal movement into frame steps
      const steps = Math.round(dx / drag.pxPerFrame);
      setFrameByIndex(drag.startIdx + steps);

      e.preventDefault();
    }

    function endDrag(e){
      if (!drag.active) return;
      if (drag.pointerId !== null && e.pointerId !== drag.pointerId) return;
      drag.active = false;
      drag.pointerId = null;
    }

    // Attach to both panes (works for mouse + touch via Pointer Events)
    [els.paneAWrap, els.paneBWrap].forEach(el => {
      el.addEventListener("pointerdown", onDown);
      el.addEventListener("pointermove", onMove);
      el.addEventListener("pointerup", endDrag);
      el.addEventListener("pointercancel", endDrag);
      el.addEventListener("pointerleave", endDrag);
    });
  }

  render();
</script>
</body>
</html>
